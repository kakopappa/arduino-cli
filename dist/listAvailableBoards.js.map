{"version":3,"sources":["../src/listAvailableBoards.js"],"names":["R","fse","ORIGINAL_PACKAGE_INDEX_FILE","getPackageIndexFiles","getConfig","packagesDir","config","urls","pathOr","ADDITIONAL_URLS_PATH","filepaths","compose","map","fname","path","join","append","last","split","prop","parse","readPackages","composeP","unnest","pluck","x","Promise","all","readJson","sortByVersion","sort","useWith","versionCompare","getAvailableBoards","pkg","values","arch","assoc","name","architecture","version","pipe","groupBy"],"mappings":";;;;;;AAeA;;;;AACA;;AACA;;IAAYA,C;;AACZ;;IAAYC,G;;AACZ;;;;AAEA;;;;;;AArBA;;;;;;;;;;;;;;;AAuBA,MAAMC,8BAA8B,oBAApC;;AAEA;;AAEA;;;;;;;;AAQA,MAAMC,uBAAuB,OAAOC,SAAP,EAAkBC,WAAlB,KAAkC;AAC7D,QAAMC,SAAS,MAAMF,WAArB;AACA,QAAMG,OAAOP,EAAEQ,MAAF,CAAS,EAAT,EAAaC,4BAAb,EAAmCH,MAAnC,CAAb;AACA,QAAMI,YAAYV,EAAEW,OAAF,CAChBX,EAAEY,GAAF,CAAMC,SAASC,eAAKC,IAAL,CAAUV,WAAV,EAAuBQ,KAAvB,CAAf,CADgB,EAEhBb,EAAEgB,MAAF,CAASd,2BAAT,CAFgB,EAGhBF,EAAEY,GAAF,CAAMZ,EAAEW,OAAF,CAAUX,EAAEiB,IAAZ,EAAkBjB,EAAEkB,KAAF,CAAQ,GAAR,CAAlB,EAAgClB,EAAEmB,IAAF,CAAO,UAAP,CAAhC,EAAoDC,UAApD,CAAN,CAHgB,EAIhBb,IAJgB,CAAlB;AAKA,SAAOG,SAAP;AACD,CATD;;AAWA;;;;;;AAMA,MAAMW,eAAerB,EAAEsB,QAAF,CAAWtB,EAAEuB,MAAb,EAAqBvB,EAAEwB,KAAF,CAAQ,UAAR,CAArB,EAA0CC,KAC7DC,QAAQC,GAAR,CAAY3B,EAAEY,GAAF,CAAMX,IAAI2B,QAAV,EAAoBH,CAApB,CAAZ,CADmB,CAArB;;AAIA,MAAMI,gBAAgB7B,EAAE8B,IAAF,CACpB9B,EAAE+B,OAAF,CAAUC,4BAAV,EAA0B,CAAChC,EAAEmB,IAAF,CAAO,SAAP,CAAD,EAAoBnB,EAAEmB,IAAF,CAAO,SAAP,CAApB,CAA1B,CADoB,CAAtB;;AAIA;AACA,MAAMc,qBAAqBjC,EAAEW,OAAF,CACzBX,EAAEuB,MADuB,EAEzBvB,EAAEY,GAAF,CAAMsB,OACJlC,EAAEW,OAAF,CACEX,EAAEuB,MADJ,EAEEvB,EAAEmC,MAFJ,EAGEnC,EAAEY,GAAF,CAAMwB,QACJpC,EAAEW,OAAF,CACEX,EAAEY,GAAF,CACEZ,EAAEW,OAAF,CACEX,EAAEqC,KAAF,CAAQ,aAAR,EAAuBD,KAAKE,IAA5B,CADF,EAEEtC,EAAEqC,KAAF,CAAQ,SAAR,EAAoB,GAAEH,IAAII,IAAK,IAAGF,KAAKG,YAAa,EAApD,CAFF,EAGEvC,EAAEqC,KAAF,CAAQ,SAAR,EAAmBD,KAAKI,OAAxB,CAHF,CADF,CADF,EAQExC,EAAEmB,IAAF,CAAO,QAAP,CARF,EASEiB,IATF,CADF,CAHF,EAeEpC,EAAEY,GAAF,CAAMZ,EAAEyC,IAAF,CAAOZ,aAAP,EAAsB7B,EAAEiB,IAAxB,CAAN,CAfF,EAgBEjB,EAAE0C,OAAF,CAAU1C,EAAEmB,IAAF,CAAO,cAAP,CAAV,CAhBF,EAiBEnB,EAAEmB,IAAF,CAAO,WAAP,CAjBF,EAkBEe,GAlBF,CADF,CAFyB,CAA3B;;AAyBA;;;;;;kBAMelC,EAAEsB,QAAF,CACbW,kBADa,EAEbZ,YAFa,EAGblB,oBAHa,C","file":"listAvailableBoards.js","sourcesContent":["/**\n * Module provides one function, that searches and reads all package_*_index.json\n * files and get all board names from them.\n * We need this function, because `arduino-cli board listall` shows only\n * boards of already installed packages.\n *\n * Function accepts a path to the directory with `package_*_index.json` files\n * and returns a Promise with a list of objects like this:\n * {\n *   name: 'Arduino Nano',\n *   package: 'arduino:avr',\n *   version: '1.6.12'\n * }\n */\n\nimport path from 'path';\nimport { parse } from 'url';\nimport * as R from 'ramda';\nimport * as fse from 'fs-extra';\nimport versionCompare from 'tiny-version-compare';\n\nimport { ADDITIONAL_URLS_PATH } from './config';\n\nconst ORIGINAL_PACKAGE_INDEX_FILE = 'package_index.json';\n\n// AvailableBoard :: { name :: String, package :: String }\n\n/**\n * Returns a list of paths to the additional package index files.\n *\n * Gets filenames of additional package index files from arduino cli config\n * by parsing URLs and joins filenames with path to packages directory.\n *\n * :: (() -> Promise Object Error) -> Path -> Promise [Path] Error\n */\nconst getPackageIndexFiles = async (getConfig, packagesDir) => {\n  const config = await getConfig();\n  const urls = R.pathOr([], ADDITIONAL_URLS_PATH, config);\n  const filepaths = R.compose(\n    R.map(fname => path.join(packagesDir, fname)),\n    R.append(ORIGINAL_PACKAGE_INDEX_FILE),\n    R.map(R.compose(R.last, R.split('/'), R.prop('pathname'), parse))\n  )(urls);\n  return filepaths;\n};\n\n/**\n * Reads package index json files, take all package object from them and\n * returns one list of packages.\n *\n * :: [Path] -> Promise [Object] Error\n */\nconst readPackages = R.composeP(R.unnest, R.pluck('packages'), x =>\n  Promise.all(R.map(fse.readJson, x))\n);\n\nconst sortByVersion = R.sort(\n  R.useWith(versionCompare, [R.prop('version'), R.prop('version')])\n);\n\n// :: [Object] -> [AvailableBoard]\nconst getAvailableBoards = R.compose(\n  R.unnest,\n  R.map(pkg =>\n    R.compose(\n      R.unnest,\n      R.values,\n      R.map(arch =>\n        R.compose(\n          R.map(\n            R.compose(\n              R.assoc('packageName', arch.name),\n              R.assoc('package', `${pkg.name}:${arch.architecture}`),\n              R.assoc('version', arch.version)\n            )\n          ),\n          R.prop('boards')\n        )(arch)\n      ),\n      R.map(R.pipe(sortByVersion, R.last)),\n      R.groupBy(R.prop('architecture')),\n      R.prop('platforms')\n    )(pkg)\n  )\n);\n\n/**\n * Reads all package index json files in the specified directory\n * and returns a promise with a list of Available Boards.\n *\n * :: (() -> Promise Object Error) -> Path -> Promise [AvailableBoard] Error\n */\nexport default R.composeP(\n  getAvailableBoards,\n  readPackages,\n  getPackageIndexFiles\n);\n"]}